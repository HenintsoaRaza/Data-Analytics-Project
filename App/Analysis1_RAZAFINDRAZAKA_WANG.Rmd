---
title: "Airbnb data analysis"
authors: "RAZAFINDRAZAKA Henintsoa, WANG James"
date: "November 7, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<div>
  <center> Authors: </center>
  <center> RAZAFINDRAZAKA Henintsoa </center>
  <center> WANG James </center>
</div>


# Data Preprocessing

For the preprocessing, we use the preprocessing script. We run this script with source().

```{r message=FALSE, warning = FALSE}
source("../Scripts/data_preparation_script.R", local = knitr::knit_global())
```


let's plot the head of listings data set : 

```{r message=FALSE, warning = FALSE}
head(listings)
```

# Analysis 1
## Find the "average availability over 30 days" of listings per each city.
```{r message=FALSE, warning = FALSE}
listings %>%
  group_by(city) %>%
  summarise(average_availability_30 = mean(availability_30))
```

## Find the "average revenue of over 30 days" of listings per each city.
```{r message=FALSE, warning = FALSE}
listings %>%
  group_by(city) %>%
  summarise(Mean_revenue_30 = mean(revenue_30))
```

## Comparing the distribution of estimated availability for the next 30 days of listings per each city.
```{r message=FALSE, warning = FALSE}
avgAvai30 <- ggplot(listings, aes(city, availability_30, fill=city))
avgAvai30 + geom_boxplot(aes(colour = "red"), outlier.shape = NA) +
  scale_y_continuous(limits = quantile(listings$availability_30, c(0.1, 0.9), na.rm = T)) +
  scale_fill_brewer(palette="Set1") 
```

## Comparing the distribution of estimated revenue for the next 30 days of listings per each city.

```{r message=FALSE, warning = FALSE}
avgRev30 <- ggplot(listings, aes(city, revenue_30, fill=city))
avgRev30 + geom_boxplot(aes(colour = "red"),  outlier.shape = NA) +
  scale_y_continuous(limits = quantile(listings$revenue_30, c(0.1, 0.9), na.rm = T)) +
  scale_fill_brewer(palette="Set1") 
```

## Compare the distribution of estimated revenue for the next 30 days of listings per each city & for each house size (# of bedrooms).
```{r message=FALSE, warning = FALSE}
avgRev30_city_bed <- ggplot(listings[!is.na(listings$bedrooms),], aes(city, revenue_30, fill=city))

avgRev30_city_bed + geom_boxplot(aes(colour = bedrooms), lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
  scale_y_continuous(limits = quantile(listings$revenue_30, c(0.1, 0.9), na.rm = T)) +
  scale_fill_brewer(palette="Set1") 
```

## Compare the distribution of estimated revenue for the next 30 days of listings per each city & for each room type (room_type).
```{r message=FALSE, warning = FALSE}
avgRev30_city_roomType <- ggplot(listings, aes(city, revenue_30, fill=city))

avgRev30_city_roomType + geom_boxplot(aes(colour = room_type),  lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
  scale_y_continuous(limits = quantile(listings$revenue_30, c(0.1, 0.9), na.rm = T)) +
  scale_fill_brewer(palette="Set1") 
```


# Analysis 2 : 
## What is the proportion of each room type?

```{r message=FALSE, warning = FALSE}
for(c in cities){
    proportion_RoomType <- ggplot(listings[listings$city == c,], aes(room_type))
    g <- proportion_RoomType + 
      geom_bar(aes(y = (..count..)/sum(..count..), fill=factor(..x..)), stat= "count")+
      geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),3)),
                    y= ((..count..)/sum(..count..))), stat="count",
                vjust = -.25) + theme(legend.position = "none") + facet_wrap(~ city) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    ylab("Proportion")
    print(g)
}
```

## What is the proportion of each house size (# of bedroom)?

```{r message=FALSE, warning = FALSE}
for(c in cities){
  proportion_bedrooms<- ggplot(listings[listings$city == c & !is.na(listings$bedrooms), ], aes(bedrooms))
  g <- proportion_bedrooms + 
    geom_bar(aes(y = (..count..)/sum(..count..), fill=factor(..x..)), stat= "count")+
    geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),4)),
                  y= ((..count..)/sum(..count..))), stat="count",
              vjust = -.25) + 
    ylab("Percentage ") + facet_wrap(~ city) + theme(legend.position = "none")
  print(g)
}
```


## What is the proportion of each neighborhood?

```{r message=FALSE, warning = FALSE}
proportion_neighborhood<- ggplot(listings, aes(neighbourhood_cleansed))
proportion_neighborhood + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill=factor(..x..)), stat= "count")+
  geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),2)),
                y= ((..count..)/sum(..count..))), stat="count",
            vjust = -.25) + 
  ylab("Percentage ") + theme(legend.position = "none") + coord_flip()
```
- Find the top 10 neighborhood :
```{r message=FALSE, warning = FALSE}
top_10_neighborhood <- listings %>%
  group_by(city) %>%
  count(neighbourhood_cleansed) %>%
  arrange(city, desc(n))

top_10_neighborhood
```

- Plot top 10 neighborhood proportions :
```{r message=FALSE, warning = FALSE}
for(c in cities){
  proportion_10neighborhood<- ggplot(slice(top_10_neighborhood[top_10_neighborhood$city == c,], 0:10), aes(x = reorder(neighbourhood_cleansed, -n), fill= n))
  
  g <- proportion_10neighborhood + 
  geom_bar(aes(x = neighbourhood_cleansed, y = n), stat="identity",  lwd = 0.8, position = position_dodge(0.9), na.rm = T) +
  theme(legend.position = "none") + coord_flip() + facet_wrap(~ city) + xlab("Neighborhoods ") + ylab("Proportions") 
  
  print(g)
}
```


## What is the average availability over the next 30 days for each room type / house size / neighborhood?
```{r message=FALSE, warning = FALSE}
for (c in cities) {
  df1 <- listings[listings$city == c,] %>%
    group_by(city, room_type) %>%
    summarise(average_availability_30 = mean(availability_30))
  print(df1)
  
  df2 <- listings[listings$city == c,] %>%
    group_by(city, bedrooms) %>%
    summarise(average_availability_30 = mean(availability_30))
  print(df2)
  
  df3 <- listings[listings$city == c,] %>%
    group_by(city, neighbourhood_cleansed) %>%
    summarise(average_availability_30 = mean(availability_30))
  print(df3)
}
```

## What is the average revenue over the next 30 days for each room type / house size / neighborhood?

```{r message=FALSE, warning = FALSE}
for (c in cities) {
  df1 <- listings[listings$city == c,] %>%
    group_by(city, room_type) %>%
    summarise(average_revenue_30 = mean(revenue_30))
  print(df1)
  
  df2 <- listings[listings$city == c,] %>%
    group_by(city, bedrooms) %>%
    summarise(average_revenue_30 = mean(revenue_30))
  print(df2)
  
  df3 <- listings[listings$city == c,] %>%
    group_by(city, neighbourhood_cleansed) %>%
    summarise(average_revenue_30 = mean(revenue_30))
  print(df3)
}
```


## What is the distribution of availability over the next 30 days for each room type / house size / neighborhood?

- distribution of availability for the next 30 days per each city and room type

```{r message=FALSE, warning = FALSE}
for (c in cities) {
  Avai30_city_roomType <- ggplot(listings[listings$city == c,], aes(city, availability_30, fill=room_type))
  
  g <- Avai30_city_roomType + geom_boxplot(lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
    scale_y_continuous(limits = quantile(listings$availability_30, c(0.1, 0.9), na.rm = T)) +
    scale_fill_brewer(palette="Set1") 
  
  print(g)
}
```


 - distribution of availability for the next 30 days per each city and house size

```{r message=FALSE, warning = FALSE}
for (c in cities) {
  Avai30_city_bedrooms <- ggplot(listings[listings$city == c & !is.na(listings$bedrooms), ], aes(city, availability_30, fill=bedrooms))
  
  g <- Avai30_city_bedrooms + geom_boxplot(lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
    scale_y_continuous(limits = quantile(listings$availability_30, c(0.1, 0.9), na.rm = T)) +
    scale_fill_brewer(palette="Set1") 
  
  print(g)
}
```

- distribution of availability for the next 30 days per each city and neighborhood

```{r message=FALSE, warning = FALSE}
Availability30_top_10_neighborhood <- listings %>%
  group_by(city, neighbourhood_cleansed) %>%
  summarise(sum_avai30 = sum(availability_30)) %>%
  top_n(10)
  #arrange(city, desc(sum_avai30))

Availability30_top_10_neighborhood
```

```{r message=FALSE, warning = FALSE}
for(c in cities){
  Avai30_city_neighbourhood_cleansed <- ggplot(listings[listings$city == c & listings$neighbourhood_cleansed %in% Availability30_top_10_neighborhood$neighbourhood_cleansed,], aes(city, availability_30, fill=neighbourhood_cleansed))
  
  g <- Avai30_city_neighbourhood_cleansed + 
  geom_boxplot(lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
  scale_y_continuous(limits = quantile(listings$availability_30, c(0.1, 0.9), na.rm = T)) +
  scale_fill_brewer(palette="Spectral") 
  
  print(g)
}
```



## What is the distribution of revenue over the next 30 days for each room type / house size / neighborhood?

 - distribution of revenue over the next 30 days for each room type and each city 

```{r message=FALSE, warning = FALSE}
for (c in cities) {
  Rev30_city_roomType <- ggplot(listings[listings$city == c,], aes(city, revenue_30, fill=room_type))
  
  g <- Rev30_city_roomType + geom_boxplot(lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
    scale_y_continuous(limits = quantile(listings$revenue_30, c(0.1, 0.9), na.rm = T)) +
    scale_fill_brewer(palette="Set1") 
  
  print(g)
}
```

 - distribution of revenue over the next 30 days for each room type and each city 
 
```{r message=FALSE, warning = FALSE}
for (c in cities) {
  Rev30_city_bedrooms <- ggplot(listings[listings$city == c & !is.na(listings$bedrooms), ], aes(city, revenue_30, fill=bedrooms))
  
  g <- Rev30_city_bedrooms + geom_boxplot(lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
    scale_y_continuous(limits = quantile(listings$revenue_30, c(0.1, 0.9), na.rm = T)) +
    scale_fill_brewer(palette="Spectral") 
  
  print(g)
}
```

 - distribution of revenue over the next 30 days for each neighborhood and each city 

```{r message=FALSE, warning = FALSE}
Revenue30_top_10_neighborhood <- listings %>%
  group_by(city, neighbourhood_cleansed) %>%
  summarise(sum_revenue30 = sum(revenue_30)) %>%
  top_n(10)

Revenue30_top_10_neighborhood
```

```{r message=FALSE, warning = FALSE}
for(c in cities){
  Rev30_city_neighbourhood_cleansed <- ggplot(listings[listings$city == c & listings$neighbourhood_cleansed %in% Availability30_top_10_neighborhood$neighbourhood_cleansed,], aes(city, revenue_30, fill=neighbourhood_cleansed))
  
  g <- Rev30_city_neighbourhood_cleansed + 
  geom_boxplot(lwd = 0.8, position = position_dodge(0.9), outlier.shape = NA) +
  scale_y_continuous(limits = quantile(listings$revenue_30, c(0.1, 0.9), na.rm = T)) +
  scale_fill_brewer(palette="Spectral") 
  
  print(g)
}
```
